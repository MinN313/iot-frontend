<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CÃ i Ä‘áº·t - IoT</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dark-theme">
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-logo"><h2>ğŸ  IoT</h2></div>
            <ul class="sidebar-menu" id="sidebar-menu">
                <li><a href="dashboard.html"><span class="icon">ğŸ“Š</span><span data-lang="dashboard">Dashboard</span></a></li>
                <li id="menu-slots" style="display:none"><a href="slots.html"><span class="icon">ğŸ“±</span><span data-lang="slots">Quáº£n lÃ½ Slots</span></a></li>
                <li id="menu-admin" style="display:none"><a href="admin.html"><span class="icon">ğŸ‘‘</span><span data-lang="admin">Admin</span></a></li>
                <li><a href="settings.html" class="active"><span class="icon">âš™ï¸</span><span data-lang="settings">CÃ i Ä‘áº·t</span></a></li>
            </ul>
        </nav>
        
        <main class="main-content">
            <header class="header">
                <h1>âš™ï¸ <span data-lang="settings">CÃ i Ä‘áº·t</span></h1>
                <button class="btn-logout" onclick="logout()" data-lang="logout">ÄÄƒng xuáº¥t</button>
            </header>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Profile -->
            <div class="settings-section">
                <h3>ğŸ‘¤ <span data-lang="profile">Há»“ sÆ¡</span></h3>
                <form onsubmit="updateProfile(event)">
                    <div class="form-group">
                        <label data-lang="name">TÃªn</label>
                        <input type="text" id="profile-name" placeholder="TÃªn cá»§a báº¡n">
                    </div>
                    <div class="form-group">
                        <label data-lang="email">Email</label>
                        <input type="email" id="profile-email" disabled>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:auto" data-lang="save">LÆ°u</button>
                </form>
            </div>
            
            <!-- Password -->
            <div class="settings-section">
                <h3>ğŸ”‘ <span data-lang="changePassword">Äá»•i máº­t kháº©u</span></h3>
                <form onsubmit="changePassword(event)">
                    <div class="form-group">
                        <label data-lang="oldPassword">Máº­t kháº©u cÅ©</label>
                        <input type="password" id="old-password" required>
                    </div>
                    <div class="form-group">
                        <label data-lang="newPassword">Máº­t kháº©u má»›i</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div class="form-group">
                        <label data-lang="confirmPassword">XÃ¡c nháº­n</label>
                        <input type="password" id="confirm-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:auto" data-lang="save">LÆ°u</button>
                </form>
            </div>
            
            <!-- Theme -->
            <div class="settings-section">
                <h3>ğŸ¨ <span data-lang="theme">Giao diá»‡n</span></h3>
                <div class="settings-row">
                    <span class="settings-label" data-lang="theme">Cháº¿ Ä‘á»™</span>
                    <div class="settings-value">
                        <button class="theme-btn" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ <span data-lang="dark">Tá»‘i</span></button>
                        <button class="theme-btn" id="theme-light" onclick="setTheme('light')">â˜€ï¸ <span data-lang="light">SÃ¡ng</span></button>
                    </div>
                </div>
            </div>
            
            <!-- Language -->
            <div class="settings-section">
                <h3>ğŸŒ <span data-lang="language">NgÃ´n ngá»¯</span></h3>
                <div class="settings-row">
                    <span class="settings-label" data-lang="language">NgÃ´n ngá»¯</span>
                    <div class="settings-value">
                        <button class="lang-btn" id="lang-vi" onclick="setLanguage('vi')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
                        <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">ğŸ‡ºğŸ‡¸ English</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            initSettings();
            loadProfile();
            updateThemeButtons();
            updateLangButtons();
            
            // Menu theo phÃ¢n quyá»n
            const user = getCurrentUser();
            if (user && user.role === 'admin') {
                document.getElementById('menu-slots').style.display = 'block';
                document.getElementById('menu-admin').style.display = 'block';
            }
        });
        
        async function loadProfile() {
            const data = await apiCall('/api/user/profile');
            if (data && data.success) {
                document.getElementById('profile-name').value = data.data.name || '';
                document.getElementById('profile-email').value = data.data.email || '';
            }
        }
        
        async function updateProfile(e) {
            e.preventDefault();
            const name = document.getElementById('profile-name').value.trim();
            const theme = localStorage.getItem('theme') || 'dark';
            const language = localStorage.getItem('language') || 'vi';
            
            const res = await apiCall('/api/user/profile', 'PUT', { name, theme, language });
            if (res && res.success) {
                const user = getCurrentUser();
                user.name = name;
                localStorage.setItem('user', JSON.stringify(user));
                showSuccess('ÄÃ£ cáº­p nháº­t!');
            } else {
                showError('Lá»—i!');
            }
        }
        
        async function changePassword(e) {
            e.preventDefault();
            const oldPw = document.getElementById('old-password').value;
            const newPw = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            
            if (newPw.length < 6) { showError('Máº­t kháº©u má»›i Ã­t nháº¥t 6 kÃ½ tá»±!'); return; }
            if (newPw !== confirm) { showError('Máº­t kháº©u khÃ´ng khá»›p!'); return; }
            
            const res = await apiCall('/api/user/password', 'PUT', { old_password: oldPw, new_password: newPw });
            if (res && res.success) {
                showSuccess('Äá»•i máº­t kháº©u thÃ nh cÃ´ng!');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else {
                showError(res?.error || 'Lá»—i!');
            }
        }
        
        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme();
            updateThemeButtons();
            // Save to server
            apiCall('/api/user/profile', 'PUT', { theme });
        }
        
        function setLanguage(lang) {
            localStorage.setItem('language', lang);
            updateTexts();
            updateLangButtons();
            // Save to server
            apiCall('/api/user/profile', 'PUT', { language: lang });
        }
        
        function updateThemeButtons() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.getElementById('theme-dark').classList.toggle('active', theme === 'dark');
            document.getElementById('theme-light').classList.toggle('active', theme === 'light');
        }
        
        function updateLangButtons() {
            const lang = localStorage.getItem('language') || 'vi';
            document.getElementById('lang-vi').classList.toggle('active', lang === 'vi');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        }
    </script>
</body>
</html>
